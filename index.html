<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Home Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      max-width: 800px;
      width: 100%;
      padding: 24px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 4px;
    }
    .mode {
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.7;
      margin-bottom: 16px;
    }
    .status-row {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
      font-size: 0.8rem;
    }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      display: inline-block;
    }
    .pill-ok { background: #16a34a22; color: #4ade80; }
    .pill-bad { background: #b91c1c22; color: #f87171; }
    .pill-warn { background: #a1620722; color: #facc15; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 16px 20px 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.7);
      text-align: center;
      border: 1px solid #1e293b;
    }
    .card h2 {
      margin: 0 0 4px;
      font-size: 1.1rem;
    }
    .device-topic {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-bottom: 8px;
    }
    .circle {
      width: 70px;
      height: 70px;
      border-radius: 999px;
      margin: 8px auto 10px;
      box-shadow: 0 0 30px rgba(15,23,42,1);
      transition: background 0.18s ease, box-shadow 0.18s ease;
    }
    .circle.on {
      background: radial-gradient(circle at 30% 20%, #facc15, #f97316);
      box-shadow: 0 0 45px rgba(250,204,21,0.9);
    }
    .circle.off {
      background: radial-gradient(circle at 30% 20%, #111827, #020617);
    }
    .state-text {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .small {
      font-size: 0.75rem;
      opacity: 0.6;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 20px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-top: 8px;
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.2s ease;
    }
    .btn-on {
      background: linear-gradient(135deg, #facc15, #f97316);
      color: #111827;
      box-shadow: 0 10px 25px rgba(248,250,252,0.15);
    }
    .btn-off {
      background: #111827;
      color: #e5e7eb;
      box-shadow: 0 10px 25px rgba(15,23,42,0.9);
    }
    .btn:active {
      transform: scale(0.97);
      box-shadow: 0 4px 15px rgba(0,0,0,0.8);
    }
    .hint {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.6;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Smart Home â€“ Lights</h1>
    <div id="modeLabel" class="mode">Connectingâ€¦</div>

    <div class="status-row">
      <span id="localStatus" class="pill pill-warn">Local: connectingâ€¦</span>
      <span id="cloudStatus" class="pill pill-warn">Cloud: connectingâ€¦</span>
    </div>

    <div class="grid">
      <!-- Light 1 -->
      <div class="card" id="card-light1">
        <h2>Light 1</h2>
        <div class="device-topic">CMD: home/light1/cmd &nbsp;Â·&nbsp; STATE: home/light1/state</div>
        <div class="circle off" id="circle-light1"></div>
        <div class="state-text" id="stateText-light1">Unknown</div>
        <div class="small" id="sourceText-light1">Waiting for stateâ€¦</div>
        <button class="btn btn-off" id="btn-light1">Turn ON</button>
      </div>

      <!-- Light 2 -->
      <div class="card" id="card-light2">
        <h2>Light 2</h2>
        <div class="device-topic">CMD: home/light2/cmd &nbsp;Â·&nbsp; STATE: home/light2/state</div>
        <div class="circle off" id="circle-light2"></div>
        <div class="state-text" id="stateText-light2">Unknown</div>
        <div class="small" id="sourceText-light2">Waiting for stateâ€¦</div>
        <button class="btn btn-off" id="btn-light2">Turn ON</button>
      </div>
    </div>

    <div class="hint">
      Dashboard first tries local MQTT (192.168.0.144:9001).<br />
      If that fails, it automatically falls back to HiveMQ Cloud.
    </div>
  </div>

  <script>
  // ====== CONFIG ======
  const DEVICES = {
    light1: {
      id: "light1",
      cmdTopic: "home/light1/cmd",
      stateTopic: "home/light1/state",
      state: "OFF"
    },
    light2: {
      id: "light2",
      cmdTopic: "home/light2/cmd",
      stateTopic: "home/light2/state",
      state: "OFF"
    }
  };

  const LOCAL_URL = "ws://192.168.0.144:9001";
  const CLOUD_URL = "wss://855677dcf06a47379e9bb069a058ee3a.s1.eu.hivemq.cloud:8884/mqtt";
  const CLOUD_USER = "SmartLife";
  const CLOUD_PASS = "Metrouni2025";

  const STATE_TOPICS = Object.values(DEVICES).map(d => d.stateTopic);

  // ====== UI ELEMENTS ======
  const modeLabel   = document.getElementById("modeLabel");
  const localStatus = document.getElementById("localStatus");
  const cloudStatus = document.getElementById("cloudStatus");

  function setPill(el, text, cls) {
    el.textContent = text;
    el.className = "pill " + cls;
  }

  function updateDeviceUI(deviceId, state, source = "") {
    const dev = DEVICES[deviceId];
    if (!dev) return;

    dev.state = (state || "").toUpperCase() === "ON" ? "ON" : "OFF";

    const circle   = document.getElementById("circle-" + deviceId);
    const stateEl  = document.getElementById("stateText-" + deviceId);
    const sourceEl = document.getElementById("sourceText-" + deviceId);
    const btn      = document.getElementById("btn-" + deviceId);

    const isOn = dev.state === "ON";

    circle.classList.toggle("on", isOn);
    circle.classList.toggle("off", !isOn);

    stateEl.textContent = isOn ? "Light is ON" : "Light is OFF";
    btn.textContent = isOn ? "Turn OFF" : "Turn ON";

    btn.classList.toggle("btn-on", isOn);
    btn.classList.toggle("btn-off", !isOn);

    if (source) {
      sourceEl.textContent = "Last update from: " + source;
    }
  }

  // init UI
  updateDeviceUI("light1", "OFF");
  updateDeviceUI("light2", "OFF");

  let client = null;
  let currentMode = ""; // "local" or "cloud"

  function setupSubscriptions() {
    if (!client) return;
    client.subscribe(STATE_TOPICS, (err, granted) => {
      if (err) {
        console.error("Subscribe error:", err);
      } else {
        console.log("Subscribed to:", granted.map(g => g.topic).join(", "));
      }
    });

    client.on("message", (topic, payload) => {
      const msg = payload.toString().trim();
      console.log("MQTT:", topic, msg);

      const devEntry = Object.values(DEVICES).find(d => d.stateTopic === topic);
      if (devEntry) {
        const source = currentMode === "local" ? "Local" :
                       currentMode === "cloud" ? "Cloud" : "Unknown";
        updateDeviceUI(devEntry.id, msg, source);
      }
    });
  }

  function retryConnection() {
    setTimeout(() => {
      modeLabel.textContent = "Retrying connectionâ€¦";
      connectLocalFirst();
    }, 10000);
  }

  function connectLocalFirst() {
    modeLabel.textContent = "Trying local brokerâ€¦";
    setPill(localStatus, "Local: connectingâ€¦", "pill-warn");

    const localClient = mqtt.connect(LOCAL_URL, {
      reconnectPeriod: 0,     // ðŸ”´ no auto reconnect
      connectTimeout: 3000
    });

    let resolved = false;

    localClient.on("connect", () => {
      resolved = true;
      currentMode = "local";
      client = localClient;

      modeLabel.textContent = "Connected (Local Mode)";
      setPill(localStatus, "Local: connected", "pill-ok");
      setPill(cloudStatus, "Cloud: standby", "pill-warn");

      setupSubscriptions();
    });

    localClient.on("error", (err) => {
      console.error("Local MQTT error:", err && err.message);
      localClient.end(true);
      if (!resolved) {
        resolved = true;
        setPill(localStatus, "Local: failed", "pill-bad");
        connectCloudFallback();
      }
    });

    localClient.on("close", () => {
      console.log("Local MQTT closed");
      if (!resolved) {
        resolved = true;
        setPill(localStatus, "Local: closed", "pill-bad");
        connectCloudFallback();
      } else if (currentMode === "local") {
        setPill(localStatus, "Local: disconnected", "pill-bad");
        modeLabel.textContent = "Local lost, trying Cloudâ€¦";
        connectCloudFallback();
      }
    });
  }

  function connectCloudFallback() {
    modeLabel.textContent = "Trying HiveMQ Cloudâ€¦";
    setPill(cloudStatus, "Cloud: connectingâ€¦", "pill-warn");

    const cloudClient = mqtt.connect(CLOUD_URL, {
      username: CLOUD_USER,
      password: CLOUD_PASS,
      reconnectPeriod: 0,   // ðŸ”´ no auto reconnect
      connectTimeout: 4000
    });

    let resolved = false;

    cloudClient.on("connect", () => {
      resolved = true;
      currentMode = "cloud";
      client = cloudClient;

      modeLabel.textContent = "Connected (Cloud Mode)";
      setPill(cloudStatus, "Cloud: connected", "pill-ok");
      if (localStatus.textContent.includes("connecting")) {
        setPill(localStatus, "Local: unavailable", "pill-bad");
      }

      setupSubscriptions();
    });

    cloudClient.on("error", (err) => {
      console.error("Cloud MQTT error:", err && err.message);
      cloudClient.end(true);
      if (!resolved) {
        resolved = true;
        setPill(cloudStatus, "Cloud: failed", "pill-bad");
        modeLabel.textContent = "No broker available ðŸ˜¢";
        retryConnection();
      }
    });

    cloudClient.on("close", () => {
      console.log("Cloud MQTT closed");
      if (!resolved) {
        resolved = true;
        setPill(cloudStatus, "Cloud: closed", "pill-bad");
        modeLabel.textContent = "No broker available ðŸ˜¢";
        retryConnection();
      } else if (currentMode === "cloud") {
        setPill(cloudStatus, "Cloud: disconnected", "pill-bad");
        modeLabel.textContent = "Disconnected from Cloud";
        retryConnection();
      }
    });
  }

  // Buttons
  function bindButtons() {
    Object.values(DEVICES).forEach(dev => {
      const btn = document.getElementById("btn-" + dev.id);
      btn.addEventListener("click", () => {
        if (!client || !client.connected) {
          alert("Not connected to MQTT broker!");
          return;
        }
        const newState = dev.state === "ON" ? "OFF" : "ON";
        client.publish(dev.cmdTopic, newState, { qos: 0, retain: false });
      });
    });
  }

  bindButtons();
  connectLocalFirst();
</script>
</body>
</html>
